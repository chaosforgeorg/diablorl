register_level "town"
{
	name  = "Tristram",
	depth = 0,
	flags = { lfTown },
	music = 'music/dtowne.wav',
	down  = "level1",
	map   = [[
==BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB==BBBBBBBBBBBBBBBBBBB==BBBBBBBBBB
B==BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBwBBBBBBBwBBBBBBBBBBBBBBBBBB==BBBBBBBBBBBBBBBBBB==BBBBBBBBBB
B==BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBwBBBBBBBwBBBBBBBBBBBBBBBBBB==BBBBBTBBBBBBBBBBBB==BBBBBTBBBB
B==BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBwBBBBBBBwBBBBBBBBBBBBBBBBBB==BBBBBBBBBBBBBBBBB==BBBBBBBBBBB
BB==BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBwwwwwwwwwBBBBBBBBBTBBBBBBBB==BBBBBBBBBBBBBBBBB==BBBBBBBBBBB
BB==BBBBBBBBBBBBBBBBBBBBBBBBTBBBBBBBBBBBBwBBBBBBBwBBBBBBBBBBBBBBBBBB==BBBBwwww..wwwwBB==BBBBBBBBBBBB
BB==BBBBBBTBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBwBBBBBBBwBBBBBBBBBBBBBBBBBBB==BBBw........wBB==BBBBTBBBBBBB
BBB==BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBwBBBTBBBwBBBBBBBBBBBBBBBBBB===BBBw........wBBB==BBBBBBBBBBB
BBB==BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBwBBBBBBBwBBBBBBBBBBBBTBBBBB==BBBBw........wBBB==BBBBBBBBBBB
BBB==BBBBBBBBBBBBTBBBBBBBBBBBBBBBBBTBBBBBwBBBBBBBwBBBBBBTBBBBBBBBBBB==BBBBw........wBBB==BBBBBBBBBBB
BBBB==BBBBBBBBBBBBBBBBBBBBBBTBBBBBBBBBBBBwBBBBBBBwBBBBBBBBBBBBBBBBBBB==BBBw........wBB==BBBBBBBBTBBB
B...==.....,.............................w....,..w...........,,,,,,,,==...w........w,.==...........B
B...==.....,.............................w....,T.w...........,,,,,,,,==...wwwwwwwwww,.==...........B
B....==.....T...........T...............Tw.....,.w.....^......,,,,,,.==..,...........,==...........B
B...,.==,....,..................T.,....^Sw.......w.,....,.............==.^...,T.......==...,.......B
B.....==......,....T...,....,.........,^^w.,.T...w.............,....,..==^........T,...==....T.....B
B..^^,.==.,,.......,............,........w......,w.....,.....T...,......==......,......==..,...,...B
B.,.^^,.==.........^^....T......T...,.T..w,......w....T.....,..^.....,.----..T.....T,..==..........B
B....,..==....,...^^...,.................w....,..w...,.......^^^,....,,.==.,.....,...,..==..,......B
B.......==......,............wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww==wwwwwwwwwwwwww==..,......B
B......==.............,......w...........w.,.....,.............T....,.T.==....,..T.,....==.........B
B.....==.....,...............w,........^^w..............,...,....,.....----............T.==..,T....B
B.....==,..........,,,.....,.w.,.......,.w...,T....,....T..........T....==.......,.....,==.........B
B...,..==...,.....,.......#######........wwwwwww.........,...............==............==....,.....B
B.....,.==..............###########.,......,...w....###.........,C...,...==..,#####....==..........B
B......T.==......,.....#############...,..tttttw..,.#V#....T.............==...#####....==....T.....B
B........==......,.T....###########....,.......,..,.#`#...........C......==...####+A....==.........B
B.......,.==...........#############.,....tt.tt,....#v#..,.....C...,.....==...#####...,.==....,....B
B.........==wwwwwwwwwwww###########............w...........T.............==.....T.......==..w......B
B.....T...==.......,...#############.....,tttttw.^^^...,.......,.^^......==..,...,......==..w,.....B
B.........==......T,....###########......,.....w..^^..T,.......,..........==.,...,....^^==..w,.....B
B^^.......==............#####>#####.......tt.ttw..............,..........==..........,..==..w......B
S^,^,...,..==.........#######`#######T.........w...T....,................==..,..........==.,.......B
SSS^^^......==,.......######```######.,....t.ttw...............,....,....==.......,,..,.==...,^^...B
SSSS^,^.,.,,==.....,.....####`####.............w,....T.,.......^^,.....,..==....,.......==.,.T.,...B
SSSS^^S^.T..==...,.........##`##.......,..^....w..,..........T............==.........^^.==.........B
SSS^^,^..,..==,........,.....x...........wwwwwww.....,T.........,..T.,,..T==.....,..^^.==...,......B
SSS^^^.....==...,.....T......x,.....,...,w...............T,...............==...T.......==..T,......B
SS^^,^....==..........,......x..........Tw.,.....,..................,...,.==..,....,..T.==.........B
SS^^S.,T..==.,...............x...........w....T.........,...,.^^^,.......==.............==...,.....B
SS^S^^..,..==wwwwwwwwwwwwww,.x.,.wwwwwwwww...,.....,..........^S^.......,==......,.....,==..T......B
SS^^^,,^....==....,.....T....x...........................,................==...........==....,.....B
SSSS^^^,^,^.==.....T......,..x.,^^^^,......,...,...............x,....,....==.,^^..,...==.,.........B
SSSSSS^S^^^^^==..,...........x.........,.........#############.x.....T.....==..........==..T.......B
SSSSSS^^S^,^^==.............,xxxxxxxxxxxxxxxxxxx.#############.x...,.....T.==.....,...==.......,...B
SSSSS^S^,^^...==...............T...............x.############+.x............==........==...........B
SSSSS^^,^,,,..==...,.....,.T..#####......,.....x.#############.x........T...==,...,..==.......,....B
SSSS^S^^.T..,..==.............#####............x..............,x..........,.----...^.==............B
SSS^^^^^^.W..,.==.............####+............x...,....,......x..^^.........==...^^==.....,.T.....B
SSSS^^^,^.,...,.==.....,....,.#####0..,....,...xxxxxxxxxxxxxxxxxx..^,.........==...,==,......,.....B
SSS^S^^^,,,,....==.,..........#####.............,......,...T....x,.T...,.T....==,...==.....,...,...B
SSS^^^^^^.......,==.........T,....T.,...,............T....,.....x..............==...==......,......B
SSS^S^,^,.........==..,....................,^^^..,...#########..x...,...,,....,==..==...,...,,,,,,,B
SSSS^^^,,,...,.....==...........,...x..w....^^.......#########T.x.###########..==..==...T...,,,,,,,B
SSS^S^^^,..T.......==,.....,...,....x..wwww..,.T...,.#########..x.###########...==.==..,....,,,,,,,B
SSS^^^^,^^.,,.....,.==..............x................#########..x.####;+#####....====.......,,,,,,,B
SSSS^^S^^,^^,.......==....,....,....xxxxxxxxxxxxxx...#######+#..x.#;;;;######,....===....,..,,,,,,,B
SSS^S^^S^^^^^^...^^^.==....T...........,.......T.x..,######;Y;..x.#;;;;;..........==........,,,,,,,B
SSS^^^^^^^^^^,^...^^^==.....,........,.########..x...######;;;;.x.#;;G;#........w.==..T.....,,,,,,,B
SSS^^^S^^S^^^^,^...^^^==...........T...#######+g.x....00...,;;;.x....x........T.w.==........,,,,,,,B
SSSS^^^S^^^^^^^^...^,^==.,.............########..xxxxxx....,;XXXXXXXXXXX....####.,.==.......,,,,,,,B
SSSSSS^^S^^^SSSS^...^^^==...^^^................,......x......XXXXXXXXXXX.,..###+<..==,......,,,,,,,B
SSSS^^^S^^^SSSKk......----..^^^^..,..............^^,..xxxxxxxXXXwwwXXXXX....####0...==.....,.......B
SSSSSS^^S^^^^SSS^....^^==..,^^^......,..T.,.....^^..........^XXXwZwDXXXX....####..,,==,......,.....B
SSSSSSSS^^^S^^^^,^.,....==^^,^^,,...............,......,T....XXXwwwXXXXX....####....==.....T...,...B
SSSSSSSSS^^SS^^^^^^,,.,,^==^^,T,^...,....,,.........########,XXXXXXXXXXX.............==..,.........B
BSSSSSSSSSS^^^S^^^,^^,^,^==^^,^^^.............,.....########....,....,,x...,.....x...==.....,......B
BSSSSSSSSSSSSS^^SS^^^^^^^^==^^^,^^..,...,..H........########...........xxxxxxxxxxx...==.....,......B
BSSSSSSSSSSSSSSS^^S^^S^S^^==^^,^^,^........,.....,..########........,....######......T==,....T.,,,,B
BSSSSSSSSSSSSSSSS^^S^^^S^^^==^^^^,^^................#######+P....,.......#####+......==......,.,,,,B
BSSSSSSSSSSSSSSSSS^^^S^^^^^==^^,^^,^,^^,^^,..,.,.,,.########..,.,....,..,######..,.,.==,.......,,,,B
BSSSSSSSSSSSSSSSSSS^^^^S^SS^==,,.^^,,^^,,^^,..,,..,,,,..,,.,,..,.,.,.,,^..^^.F..T^^,,==......,.,,,,B
BSSSSSSSSSSSSSSSSSSS^^^^^^^^==^^,^,^^,,^^,,^^,,^^^,^^,T^^,^^,^^T,^^,,^,,^^,.^^^,^^^^,==..,.T...,,,,B
BSSSSSSSSSSSSSSSSSSSS^^^S^S^^==^^^,,^^,,^^^^,^,,,^^^^^,,^^^^^^^,^^,^,^^,,^^^^^^^^^S^==.,.......,,,,B
BSSSSSSSSSSSSSSSSSSSSSS^^^^^^==^^^^^^^^^^^S^^^^^^^^S^^^^^^S^^^^^^^^^^^^^^^^^^^SS^^S.==,,......,....B
BSSSSSSSSSSSSSSSSSSSSSSSSS^^^^==S^S^^^S^^^SS^^^S^^SS^^^S^^SS^^^S^^S^^^S^^^S^^SSSSSS==^^,..,...T....B
SSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==S^SS^SSS^SSSS^SS^SSSS^SS^SSSS^SS^SSS^SSS^SS^SS^SSS==^^,^.,,..,.....B
SSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==^S^^^^,,,......B
BSSSSSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==S,^^,^,,......B
SSSSSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==,,^^,,.......B
SSSSSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==^,^^^,,.....B
SSSSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==^^,^^^,....B
SSSSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==^^,^^^^,..B
SSSSSSSSSSSSSSSSSSSSSSSSSS===SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==^^^^,^^...B
SSSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==^^^,^^^...B
SSSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS===^^,^^,...B
SSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==^^^,^....B
SSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==^^^^,....B
SSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==^^BBBBBBBB
SSSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==^BBBBBBBBB
SSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==BBBBBBBBBB
SSSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==BBBBBBBBB
SSSSSSSSSSSSSSSSSSSSSSS===SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==BBBBBBBBB
SSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==BBBBBBBB
SSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==BBBBBBB
SSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==BBBBBBB
SSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==BBBBBB
SSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==BBBBBB
SSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==BBBBBB
SSSSSSSSSSSSSSSSSSSSSSS==SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS==BBBBB
]],
	map_key = {
		['.'] = {"grass"},
		[','] = {"muddy_grass"},
		['='] = {"river"},
		['-'] = {"wooden_bridge"},
		['+'] = {"locked_door"},
		[';'] = {"sand"},
		['^'] = {"stones"},
		['#'] = {"stone_wall"},
		['`'] = {"floor"},
		['t'] = {"tomb_stone"},
		['0'] = {"town_barrel"},
		['>'] = {"stairs_down"},
		['<'] = {"stairs_up"},
		['A'] = {"grass", "adria"},
		['B'] = {"deep_grass"},
		['C'] = {"grass", "cow"},
		['D'] = {"town_square", "cain"},
		['F'] = {"grass", "farnham"},
		['G'] = {"sand", "griswold"},
		['P'] = {"muddy_grass", "pepin"},
		['S'] = {"heavy_stones"},
		['T'] = {"tree"},
		['V'] = {"stairs_down_catacombs"},
		['K'] = {"stairs_down_caves"},
		['k'] = {"heavy_stones_caves"},
		['H'] = {"muddy_grass_hell"},
		['W'] = {"grass", "wirt"},
		['X'] = {"town_square"},
		['Y'] = {"sand", "ogden"},
		['Z'] = {"fountain"},
		['g'] = {"grass", "gillian"},
		['v'] = {"closed_door_catacombs"},
		['w'] = {"town_wall"},
		['x'] = {"path"},
	},

	OnCreate = function(self)
		generator.tile_place_raw( self, self.__proto.map, self.__proto.map_key )

		ui.msg('Welcome to DiabloRL '..VERSION..'. Press @<Escape@> for menu and help.')

		-- Decide which quests to disable
		local qset = {"leoric_quest","water"}
		quests[qset[math.random(2)]].enabled = false
		qset = {"butcher","gharbad_quest","sign"}
		quests[ qset[math.random(3)] ].enabled = false
		qset = {"sky_rock_quest","valor","halls_of_blind"}
		quests[ qset[math.random(3)] ].enabled = false
		if math.random(3)~=2 then quests['mad_mage'].enabled = false end
		--[[
		qset = {"mad_mage","anvil","mushroom"}
		quests[qset[math.random(3)] ].enabled = false
		qset = {"lachdanan","warlord"}
		quests[ qset[math.random(2)] ].enabled = false
		]]--
		world.load_quest_maps()

		-- select 1 of the 3 story tome series
		player.quest["tomes"] = math.random(3)

		if quests["butcher"].enabled then
			self:drop_npc("dying", coord.new(28, 38) )
		end

		if quests["water"].enabled then
			self:set_cell(self:find_tile("fountain"),"poison_fountain")
		end
	end,

	OnEnter = function(self,loaded)
		if not loaded then
			stats.inc("enter_town")
		end
		local c = self:find_tile("stairs_up")
		if c then
	  		self:set_cell(c,"path")
	  	end
		if (player.quest["water"] == 3) then
			self:set_cell(self:find_tile("poison_fountain"),"fountain")
			player.quest["water"] = 4
		end

		if (player.quest["butcher"]==2) then
			self:drop_npc("", coord.new(28, 28) )
			player.quest["butcher"] = 3
		end

		if player.portallevel ~= "" then
			self:set_cell(coord.new(64,43),"shimmering_portal")
		else
			self:remove_travel_point(coord.new(64,43))
		end
		if TOWN_REVEAL then
			for c in area.FULL() do
				self.light[ c ][ vlfExplored ] = true
			end
			self:add_travel_point( self:find_tile("stairs_down"), cells["stairs_down"].OnTravelName(self) )
			for n in self:children("npc") do
				if n.__proto.waypoint then
					n:set_travel_point()
				end
			end
		end
		world.refresh_shops()
	end,
}
